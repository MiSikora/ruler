apply plugin: "com.github.ben-manes.versions"

buildscript {
  ext.buildConfig = [
      "compileSdk": 29,
      "minSdk": 21,
      "targetSdk": 29,
      "buildTools": "29.0.2",
  ]

  ext.versions = [
      "kotlin": "1.3.61",
      "detekt": "1.5.0",
      "kotlinTest": "3.4.2",
  ]

  ext.deps = [
      "android": [
          "x": [
              "test": "androidx.test:core:1.0.0",
          ],
          "gradlePlugin": "com.android.tools.build:gradle:4.0.0",
      ],
      "kotlin": [
          "stdLib": [
              "jdk7": "org.jetbrains.kotlin:kotlin-stdlib-jdk7:${versions.kotlin}",
          ],
          "gradlePlugin": "org.jetbrains.kotlin:kotlin-gradle-plugin:${versions.kotlin}",
      ],
      "kotlinTest": [
          "runner": "io.kotlintest:kotlintest-runner-junit5:${versions.kotlinTest}",
          "assertions": "io.kotlintest:kotlintest-assertions:${versions.kotlinTest}"
      ],
      "junit": "junit:junit:4.13",
      "robolectric": "org.robolectric:robolectric:4.3",
      "versionsGradlePlugin": "com.github.ben-manes:gradle-versions-plugin:0.27.0",
      "detekt": [
          "gradlePlugin": "io.gitlab.arturbosch.detekt:detekt-gradle-plugin:${versions.detekt}",
          "formattingPlugin": "io.gitlab.arturbosch.detekt:detekt-formatting:${versions.detekt}",
      ],
      "mavenPublishGradlePlugin": "com.vanniktech:gradle-maven-publish-plugin:0.8.0",
  ]

  repositories {
    google()
    gradlePluginPortal()
  }

  dependencies {
    classpath deps.android.gradlePlugin
    classpath deps.kotlin.gradlePlugin
    classpath deps.detekt.gradlePlugin
    classpath deps.versionsGradlePlugin
    classpath deps.mavenPublishGradlePlugin
  }
}

allprojects {
  repositories {
    mavenCentral()
    google()
    jcenter()
  }

  group = GROUP
  version = VERSION_NAME

  configurations.all {
    resolutionStrategy {
      eachDependency { details ->
        def requested = details.requested
        if (requested.name.startsWith("kotlin-stdlib")) {
          details.useTarget "" +
              "${requested.group}:" +
              "${requested.name.replace("jre", "jdk")}:" +
              "${requested.version}"
        } else if (requested.group == "org.jetbrains.kotlin") {
          details.useVersion versions.kotlin
        }
      }
    }
  }

  plugins.withType(com.android.build.gradle.BasePlugin).configureEach { plugin ->
    plugin.extension.compileOptions {
      sourceCompatibility = JavaVersion.VERSION_1_8
      targetCompatibility = JavaVersion.VERSION_1_8
    }

    android {
      compileSdkVersion buildConfig.compileSdk
      buildToolsVersion buildConfig.buildTools

      defaultConfig {
        minSdkVersion buildConfig.minSdk
        targetSdkVersion buildConfig.targetSdk
      }

      lintOptions {
        lintConfig rootProject.file("lint.xml")

        htmlReport !isCi()

        xmlReport isCi()
        xmlOutput file("build/reports/lint/lint-results.xml")

        textReport true
        textOutput "stdout"
        explainIssues false

        checkDependencies false
        checkGeneratedSources true
        checkTestSources false

        checkReleaseBuilds false
      }
    }
  }

  plugins.withType(com.android.build.gradle.LibraryPlugin).configureEach {
    android {
      variantFilter { variant ->
        if (variant.name != "release") setIgnore(true)
      }
    }
  }

  tasks.withType(JavaCompile).configureEach { task ->
    task.sourceCompatibility = JavaVersion.VERSION_1_8
    task.targetCompatibility = JavaVersion.VERSION_1_8
  }

  tasks.withType(org.jetbrains.kotlin.gradle.dsl.KotlinJvmCompile).configureEach { task ->
    task.kotlinOptions {
      jvmTarget = "1.8"
    }
  }

  tasks.withType(Test) {
    testLogging {
      events "skipped", "failed", "passed"
    }
  }

  tasks.withType(org.jetbrains.kotlin.gradle.dsl.KotlinCompile).configureEach { task ->
    task.kotlinOptions {
      freeCompilerArgs += [
          "-XXLanguage:+NewInference",
          "-progressive",
          "-Xjvm-default=enable"
      ]
    }
  }
}

apply plugin: "io.gitlab.arturbosch.detekt"

dependencies {
  detektPlugins "io.gitlab.arturbosch.detekt:detekt-formatting:${versions.detekt}"
}

detekt {
  parallel = true
  config = files("detekt-config.yml")
  input = subProjectSources()
  reports {
    xml {
      enabled = isCi()
      destination = file("build/reports/detekt/detekt-results.xml")
    }
    html.enabled = !isCi()
    txt.enabled = false
  }
}

tasks.withType(io.gitlab.arturbosch.detekt.Detekt) {
  exclude "**/test/**"
}

tasks.register("check") {
  group = "Verification"
  description = "Allows to attach Detekt to the root project."
}

private def subProjectSources() {
  def paths = subprojects.collect { subProject ->
    "${subProject.projectDir}/src".replace("${rootProject.projectDir}/", "")
  }
  return files(*paths)
}

private static def isCi() {
  //noinspection GroovyPointlessBoolean
  return System.getenv("IS_CI")?.toBoolean() == true
}

dependencyUpdates {
  rejectVersionIf {
    isNotStable(it.candidate.version) && !isNotStable(it.currentVersion)
  }
}

private static def isNotStable(String version) {
  def stableKeyword = ["rc", "cr", "beta"].any { version.toLowerCase().contains(it) }
  def regex = /^[0-9,.v-]+(-r)?$/
  return !stableKeyword && !(version ==~ regex)
}
